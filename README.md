# Text-to-SQL Assistant (FastAPI + Azure OpenAI)

This project is a natural-language-to-SQL assistant that enables users to query structured financial and operational data using plain English. It is built using FastAPI, SQLite, and Azure OpenAI (GPT-4/3.5 Turbo via Azure).

---

## 🔧 1. Setup Instructions

### Prerequisites

- Python 3.10+
- Azure OpenAI credentials (see `.env`)

### Clone and Install

```bash
git clone https://github.com/your-username/text-to-sql-assistant.git
cd text-to-sql-assistant
python -m venv venv
source venv/bin/activate  # or venv\Scripts\activate on Windows
pip install -r requirements.txt
```

### Configure Environment

Create a `.env` file:

```env
AZURE_OPENAI_API_KEY=your-azure-openai-key
AZURE_OPENAI_ENDPOINT=https://your-resource-name.openai.azure.com/
AZURE_OPENAI_DEPLOYMENT_NAME=gpt35-textsql
AZURE_OPENAI_API_VERSION=2024-02-15-preview
```

### Ingest CSV Data

Ensure all CSVs are in the `/data` folder. Then run:

```bash
python -m app.ingest
```

### Run FastAPI

```bash
uvicorn app.main:app --reload
```

Visit [http://localhost:8000/docs](http://localhost:8000/docs) for Swagger UI.

---

## 📦 2. Dependencies

In `requirements.txt`:

```txt
fastapi
uvicorn
pandas
openai
langchain
langchain_community
langchain_experimental
langchain_openai
python-dotenv
pydantic
streamlit
uvicorn
```

---

## 🧠 3. Database Schema (SQLite)

### Dimension Tables:

- `periods(id, label, year_start, year_end)`
- `ports(id, name, state)`

### Financial Tables:

- `balance_sheet(period_id, line_item, category, sub_category, value)`
- `cash_flow(period_id, item, category, value)`
- `quarterly_pnl(period_id, item, category, value, period_type)`
- `consolidated_pnl(period_id, line_item, value)`
- `roce(period_id, source, port_id, line_item, value)`

### Operational Tables:

- `volumes(period_id, port_id, commodity, entity, type, value)`
- `containers(period_id, port_id, entity, type, value)`
- `roro(period_id, port_id, type, value, number_of_cars)`

All financial and operational tables are linked to `periods`. Operational tables also link to `ports`.

---

## 🧠 Design Choices

### Model:

- **Azure OpenAI** (`gpt-4o-mini`) is used via `AzureChatOpenAI` for SQL generation and summarization.

### Prompting Strategy:

- Custom prompt (`sql_prompt.txt`) includes schema context, dialect, and few-shot examples.
- The prompt enforces grounding: queries must be based on the provided schema or return `UNSUPPORTED`.

### Chain Design:

- **Custom logic instead of SQLDatabaseChain execution** to sanitize SQL and prevent errors.
- Conversational summary generated by a second LLM call using returned table as markdown.

### API Structure:

- `/ask`: Accepts natural language, returns `sql`, `answer`, `columns`, `rows`.
- Supports `limit`, `strict_mode`, `return_table` flags.

### Architecture:

````text
 ┌────────────────────┐
 │  User / Streamlit  │◄──── UI submits natural language question
 └────────┬───────────┘
          │
          ▼
 ┌────────────────────────┐
 │ FastAPI Backend        │
 └────────┬───────────────┘
          ▼
 ┌─────────────────────────────────────┐
 │ AzureChatOpenAI + LangChain Prompt │◄── Injects schema, dialect, and instruction
 └────────┬────────────────────────────┘
          ▼
 ┌────────────────────────────┐
 │  SQL Output Sanitizer      │◄── Removes ```sql code fences, etc.
 └────────┬───────────────────┘
          ▼
 ┌────────────────────────────┐
 │  SQLite (company.db)       │
 └────────┬───────────────────┘
          ▼
 ┌────────────────────────────┐
 │  Tabular Results + Summary │
 └────────────────────────────┘
````

## ⚠️ Limitations

- Only SELECT statements are supported
- Relies on clean schema inference from prompt
- Summarization limited to first 30 rows (for brevity)
- LLM may underperform without sufficient examples in the prompt
- No support for joins on user-uploaded data

---

## 🔗 Repository

[GitHub Repository](https://github.com/your-username/text-to-sql-assistant)
